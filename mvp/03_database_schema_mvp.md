# Схема Базы Данных MVP (Supabase / PostgreSQL) v1.2

**Цель:** Минимально необходимая структура для обеспечения Главного потока с поддержкой мульти-адресов, ролей и ZIP-кодов.

## 1. Основные Таблицы (Tables)

### 1.1 `users` (Пользователи)
Единая таблица для всех ролей.

| Column | Type | Constraints | Описание |
| :--- | :--- | :--- | :--- |
| `id` | uuid | PK, default `gen_random_uuid()` | Уникальный ID |
| `phone` | text | UNIQUE, NOT NULL | Номер телефона (основной идентификатор) |
| `role` | text | default 'client' | Права доступа: `client`, `master`, `admin` |
| `sub_role` | text | | Бизнес-роль: `tenant`, `owner`, `manager`, `worker`, `company` |
| `full_name` | text | | ФИО |
| `whatsapp_id` | text | | Технический ID в WhatsApp/Twilio |
| `status` | text | default 'active' | `new`, `active`, `blocked` |
| `meta_data` | jsonb | default '{}' | Доп. данные (IBAN, zones: ['30966', '30100']) |
| `created_at` | timestamptz | default `now()` | Дата создания |

### 1.2 `user_addresses` (Адреса пользователей)
Позволяет одному пользователю иметь несколько объектов.

| Column | Type | Constraints | Описание |
| :--- | :--- | :--- | :--- |
| `id` | uuid | PK, default `gen_random_uuid()` | ID адреса |
| `user_id` | uuid | FK -> `users.id` | Владелец записи |
| `name` | text | | Название метки (напр. "Дом", "Офис") |
| `postal_code` | text | | Почтовый индекс (ZIP) - для фильтрации мастеров |
| `address_text` | text | NOT NULL | Полный текстовый адрес |
| `location` | geography | | GPS координаты (Point) |
| `is_default` | boolean | default false | Адрес по умолчанию |
| `created_at` | timestamptz | default `now()` | |

### 1.3 `requests` (Заявки)
Ядро системы.

| Column | Type | Constraints | Описание |
| :--- | :--- | :--- | :--- |
| `id` | bigint | PK, GENERATED BY DEFAULT AS IDENTITY | Номер заявки (напр. 101) |
| `user_id` | uuid | FK -> `users.id` | Кто создал (Клиент) |
| `address_id` | uuid | FK -> `user_addresses.id` | Ссылка на объект |
| `address_snapshot` | text | NOT NULL | Копия адреса для истории |
| `postal_code` | text | | ZIP-код места выполнения (копия из адреса) |
| `master_id` | uuid | FK -> `users.id` (nullable) | Кто выполняет (Мастер) |
| `status` | text | default 'new' | `new`, `assigned`, `completed`, `canceled` |
| `category` | text | | Категория (Сантехника, Электрика) |
| `description` | text | | Текст проблемы |
| `urgency` | text | default 'normal' | `normal`, `high` |
| `admin_comment` | text | | Внутренние заметки |
| `created_at` | timestamptz | default `now()` | Время создания |
| `completed_at` | timestamptz | | Время завершения |

### 1.4 `request_media` (Медиа файлы)
Связка файлов (в MinIO) с заявками.

| Column | Type | Constraints | Описание |
| :--- | :--- | :--- | :--- |
| `id` | uuid | PK, default `gen_random_uuid()` | ID записи |
| `request_id` | bigint | FK -> `requests.id` | К какой заявке относится |
| `type` | text | | `problem_photo`, `problem_audio`, `result_photo` |
| `bucket_path` | text | NOT NULL | Путь в MinIO: `requests/101/file.jpg` |
| `public_url` | text | | Публичная ссылка |
| `created_at` | timestamptz | default `now()` | |

### 1.5 `reviews` (Отзывы)
Оценки после выполнения.

| Column | Type | Constraints | Описание |
| :--- | :--- | :--- | :--- |
| `id` | uuid | PK | |
| `request_id` | bigint | FK -> `requests.id` | Заявка |
| `rating` | int | Check (1-5) | Оценка |
| `comment` | text | | Текст отзыва |

---

## 2. Представления (Views) для Админки

### 2.1 `view_dispatcher_dashboard`
Обновлено с учетом ZIP-кода.

```sql
CREATE OR REPLACE VIEW view_dispatcher_dashboard AS
SELECT
    r.id,
    r.status,
    r.created_at,
    r.postal_code,
    u.phone as client_phone,
    u.full_name as client_name,
    u.sub_role as client_type,
    r.category,
    r.address_snapshot as address,
    m.full_name as master_name
FROM requests r
JOIN users u ON r.user_id = u.id
LEFT JOIN users m ON r.master_id = m.id
WHERE r.status IN ('new', 'assigned');
```

---

## 3. SQL скрипт инициализации (Init Script)

```sql
-- Enable UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- 1. USERS
CREATE TABLE public.users (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    phone text UNIQUE NOT NULL,
    role text DEFAULT 'client' CHECK (role IN ('client', 'master', 'admin')),
    sub_role text CHECK (sub_role IN ('tenant', 'owner', 'manager', 'worker', 'company')),
    full_name text,
    whatsapp_id text,
    status text DEFAULT 'active',
    meta_data jsonb DEFAULT '{}'::jsonb,
    created_at timestamptz DEFAULT now()
);

-- 2. USER ADDRESSES
CREATE TABLE public.user_addresses (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id uuid REFERENCES public.users(id) ON DELETE CASCADE,
    name text,
    postal_code text,
    address_text text NOT NULL,
    is_default boolean DEFAULT false,
    created_at timestamptz DEFAULT now()
);

-- 3. REQUESTS
CREATE TABLE public.requests (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id uuid REFERENCES public.users(id) ON DELETE SET NULL,
    address_id uuid REFERENCES public.user_addresses(id) ON DELETE SET NULL,
    address_snapshot text NOT NULL,
    postal_code text,
    master_id uuid REFERENCES public.users(id) ON DELETE SET NULL,
    status text DEFAULT 'new' CHECK (status IN ('new', 'assigned', 'completed', 'canceled')),
    category text,
    description text,
    urgency text DEFAULT 'normal',
    admin_comment text,
    created_at timestamptz DEFAULT now(),
    completed_at timestamptz
);

-- 4. MEDIA
CREATE TABLE public.request_media (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    request_id bigint REFERENCES public.requests(id) ON DELETE CASCADE,
    type text CHECK (type IN ('problem_photo', 'problem_audio', 'result_photo')),
    bucket_path text NOT NULL,
    public_url text,
    created_at timestamptz DEFAULT now()
);

-- 5. REVIEWS
CREATE TABLE public.reviews (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    request_id bigint REFERENCES public.requests(id) ON DELETE CASCADE,
    rating int CHECK (rating >= 1 AND rating <= 5),
    comment text,
    created_at timestamptz DEFAULT now()
);

-- 6. SECURITY
ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_addresses ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.requests ENABLE ROW LEVEL SECURITY;
```
