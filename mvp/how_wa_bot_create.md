# Как создать бота WhatsApp (через Twilio)

Этот документ описывает специфику создания бота для WhatsApp по сравнению с Telegram и пошаговую инструкцию.

## 1. Telegram vs WhatsApp (Twilio)

В WhatsApp API (через Twilio) гораздо больше ограничений, чем в Telegram.

| Фича | Telegram Bot API | WhatsApp (Twilio API) | Комментарий |
| :--- | :--- | :--- | :--- |
| **Создание** | @BotFather -> Токен | Покупка номера -> Webhook URL | Нет единого "отца ботов", все через админку Twilio. |
| **Сообщения** | JSON на `api.telegram.org` | JSON на `api.twilio.com` | Разная структура данных. Twilio шлет SMS-подобные запросы. |
| **Кнопки** | Inline (много, красивые) | **Максимум 3** (Quick Replies) или Список | Очень ограниченный функционал интерфейса. |
| **Callback** | Скрытые данные (`callback_data`) | **Видимый текст** | Нажатие кнопки просто отправляет текст кнопки в чат. |
| **Инициатива** | Можно писать юзеру когда угодно | **Окно 24 часа** | Если юзер молчит >24ч, писать платно (Template Message). |
| **Группы** | Бот читает всё | Ограничено | Бот может писать в группы, но чтение часто ограничено приватностью. |

## 2. Пошаговая инструкция

### Шаг 1: Подключение (Twilio Console)
1.  Зайти в **Messaging -> Senders -> WhatsApp Senders**.
2.  Выбрать ваш номер.
3.  Настроить **Webhook** (поле "When a message comes in"):
    *   Вставить URL вашего n8n Webhook (напр. `https://n8n.your-domain.com/webhook/whatsapp`).
    *   Method: `POST`.

### Шаг 2: Прием сообщений (n8n Webhook)
Twilio отправляет `POST` запрос с полями:
*   `From`: `whatsapp:+491701234567` (ID отправителя).
*   `Body`: Текст сообщения.
*   `MediaUrl0`: Ссылка на фото/видео (если есть).
*   `ProfileName`: Имя профиля (иногда).

### Шаг 3: Отправка сообщений (n8n Twilio Node)
Используем стандартную ноду Twilio в n8n:
*   **Resource:** `SMS` (Важно! WhatsApp в Twilio считается типом SMS).
*   **From:** `whatsapp:+14155238886` (Ваш номер Twilio).
*   **To:** `{{$json.From}}` (Номер клиента).
*   **Message:** Текст ответа.

### Шаг 4: Реализация Кнопок (Workaround)
Так как кнопки отправляют текст:
1.  **Отправка:** Шлем текст "Выберите действие:\n1. Старт\n2. Помощь". (Или используем Template с кнопками).
2.  **Обработка:** В n8n ставим Switch/IF:
    *   Если `Body` == "1" или "Старт" -> Запускаем ветку Старт.

### Шаг 5: Работа с Группами (Мастера)
Для рассылки заявок в группу мастеров:
1.  Создать группу в WhatsApp.
2.  Добавить туда Бота.
3.  Узнать `GroupID` (через лог входящих сообщений в n8n).
4.  Слать сообщения на этот `GroupID` вместо номера телефона.

## 3. Ограничения "Окна 24 часов"
*   **Входящие:** Бесплатно (ответ на сообщение юзера).
*   **Исходящие (вне окна):** Платные "Template Messages". Требуют утверждения в Meta.
*   **Стратегия:** Всегда провоцировать юзера написать первым (через QR-код с предзаполненным текстом).
