# Главный информационный поток (MVP Core Flow)

**Цель MVP:** Обеспечить прохождение заявки от возникновения проблемы до её решения с минимальным ручным вмешательством диспетчера.

---

## Схема "Золотого пути" (Happy Path)

Поток движется по одной линии: **Проблема → Регистрация → Назначение → Исполнение → Закрытие.**

```mermaid
graph TD
    User((Клиент))
    Start[Вход: Фото + Текст/Аудио]
    Orchestrator[n8n Оркестратор]
    AI[OpenAI: Классификация + Адрес]
    DB[(Supabase: Таблица Requests)]
    S3[(MinIO: Фото проблемы)]
    AdminGroup[Telegram: Группа Диспетчеров/Мастеров]
    Handyman((Мастер))

    User -->|1. QR-код / WhatsApp| Start
    Start -->|2. Webhook| Orchestrator

    subgraph "Обработка (n8n + AI)"
        Orchestrator -->|3. Анализ| AI
        AI -->|4. Запись| DB
        AI -->|5. Сохранение медиа| S3
    end

    subgraph "Распределение"
        Orchestrator -->|6. Уведомление| AdminGroup
        AdminGroup -->|7. Ручное/Полу-авто назначение| Handyman
    end

    subgraph "Исполнение"
        Handyman -->|8. 'Принял в работу'| Orchestrator
        Handyman -->|9. 'Работа выполнена' + Фото| Orchestrator
        Orchestrator -->|10. Обновление статуса| DB
        Orchestrator -->|11. Сохранение отчета| S3
    end

    subgraph "Закрытие"
        Orchestrator -->|12. Уведомление| User
        User -->|13. Оценка 1-5| Orchestrator
        Orchestrator -->|14. Фиксация| DB
    end
```

---

## Детальное описание шагов

### 1. Инициация (Вход)
*   **Источник:** Клиент сканирует QR-код (в подъезде/квартире).
*   **Канал:** WhatsApp (приоритет) или Веб-форма (резерв).
*   **Данные:**
    1.  Фото проблемы (Обязательно/Желательно).
    2.  Голосовое или текст (Описание).
    3.  Номер телефона (Автоматически из WhatsApp).

### 2. Регистрация и Анализ (Ядро n8n)
*   **Действие:** n8n принимает данные.
*   **AI (OpenAI):**
    *   Транскрибирует аудио (Whisper).
    *   Анализирует текст/фото: определяет категорию (Сантехника/Электрика) и Срочность.
    *   Извлекает адрес (если пользователь уже есть в БД — подтягивает по номеру телефона).
*   **Хранение:**
    *   Создается запись в таблице `requests` (Status: `new`).
    *   Файлы загружаются в MinIO: `/requests/{uuid}/problem.jpg`.

### 3. Маршрутизация (Упрощенная для MVP)
*   *Вместо сложного алгоритма подбора:*
*   **Действие:** n8n отправляет сообщение в **Telegram-группу "Диспетчерская"** (где сидят админы и проверенные мастера).
*   **Содержание:** "Новая заявка! [Адрес] [Категория] [Фото]. Кто берет?"
*   **Назначение:** Мастер нажимает кнопку (или пишет) "Беру", Админ закрепляет заявку за ним в системе (через простую команду или админку Supabase).
*   *Опционально:* Если мастер известен (закреплен за домом), n8n шлет ему в личный WhatsApp.

### 4. Исполнение
*   **Мастер:** Получает детали заявки в WhatsApp.
*   **Старт:** Нажимает "Начал работу" (опционально для GPS трекинга).
*   **Финиш:** Отправляет в бот фото результата.
*   **Система:** Обновляет статус заявки на `completed`, сохраняет фото результата в MinIO.

### 5. Закрытие и Сервис
*   **Клиент:** Получает сообщение: "Ваша заявка [ID] выполнена. Пожалуйста, оцените работу".
*   **Оценка:** Клиент ставит 1-5 звезд.
*   **Финансы:** Система генерирует простой PDF-счет (или ссылку на оплату) и отправляет клиенту (если услуга платная).

---

## Сервисные (Вспомогательные) ветки

Эти функции обслуживают главный поток, но не блокируют его:

1.  **Регистрация Пользователя:** Если номер телефона новый → Бот спрашивает Имя и Адрес (один раз).
2.  **Регистрация Мастера:** Отдельный QR-код → Анкета → Одобрение Админом.
3.  **Биллинг:** Простая генерация PDF по шаблону в конце месяца или по факту.

